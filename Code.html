<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate Hybrid Multi-Barcode Scanner</title>
<script type="module" src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/esm/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body { font-family: Arial; text-align: center; padding: 15px; }
#readerCanvas { width: 100%; max-width: 500px; border:1px solid #ccc; border-radius:10px; }
#results, #photoResults { margin-top: 15px; font-weight:bold; color: green; word-wrap: break-word; }
canvas { margin: 5px; width: 200px; height: 200px; border:1px solid #ccc; border-radius: 10px; display:inline-block; }
input[type=file], button, input[type=range] { margin-top:10px; padding:12px 16px; font-size:18px; border-radius:8px; }
button { cursor:pointer; border:none; background:#007bff; color:white; width:180px; margin:5px; }
button:hover { background:#0056b3; }
input[type=range] { width: 80%; }
h2, h3 { margin-bottom:10px; }
</style>
</head>
<body>

<h2>Ultimate Hybrid Multi-Barcode Scanner</h2>

<h3>Live Scanner (Rear Camera)</h3>
<video id="readerCanvas" autoplay muted playsinline></video>
<div id="results">Scanning...</div>
<button id="stopBtn">Stop Live Scanner</button>
<button id="torchBtn">Toggle Torch</button>
<br>
<label for="zoomSlider">Zoom:</label>
<input type="range" id="zoomSlider" min="1" max="3" step="0.1" value="1">

<h3>Photo Scan (Native Camera)</h3>
<input type="file" accept="image/*" capture="environment" id="cameraInput">
<div id="photoResults"></div>

<script type="module">
import { MultiFormatReader, BarcodeFormat, BinaryBitmap, HybridBinarizer, RGBLuminanceSource, DecodeHintType, NotFoundException } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/esm/index.js";

const video = document.getElementById('readerCanvas');
const resultsDiv = document.getElementById('results');
const photoInput = document.getElementById('cameraInput');
const photoResultsDiv = document.getElementById('photoResults');
const stopBtn = document.getElementById('stopBtn');
const torchBtn = document.getElementById('torchBtn');
const zoomSlider = document.getElementById('zoomSlider');

let stream;
let torchOn = false;

// ZXing reader setup
const reader = new MultiFormatReader();
const hints = new Map();
hints.set(DecodeHintType.POSSIBLE_FORMATS, [BarcodeFormat.QR_CODE, BarcodeFormat.DATA_MATRIX, BarcodeFormat.PDF_417, BarcodeFormat.AZTEC]);
hints.set(DecodeHintType.TRY_HARDER, true);
reader.setHints(hints);

// --- IMAGE ENHANCEMENT ---
function enhanceImage(canvas){
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const data = imageData.data;
    for(let i=0;i<data.length;i+=4){
        const gray = 0.299*data[i]+0.587*data[i+1]+0.114*data[i+2];
        let enhanced = ((gray-128)*1.5)+128;
        enhanced = Math.min(255, Math.max(0, enhanced));
        data[i]=data[i+1]=data[i+2]=enhanced;
    }
    ctx.putImageData(imageData,0,0);
}

// --- CREATE QR CODE CANVAS ---
function createQRCanvas(text, container){
    const canvas = document.createElement('canvas');
    QRCode.toCanvas(canvas, text, {width:200});
    container.appendChild(canvas);
}

// --- LIVE SCANNER ---
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(s=>{
    stream = s;
    video.srcObject = stream;
    const track = stream.getVideoTracks()[0];
    const capabilities = track.getCapabilities();

    // Autofocus
    if(capabilities.focusMode && capabilities.focusMode.includes('continuous')){
        track.applyConstraints({advanced:[{focusMode:'continuous'}]});
    }

    // Zoom
    if(capabilities.zoom){
        zoomSlider.min=capabilities.zoom.min;
        zoomSlider.max=capabilities.zoom.max;
        zoomSlider.step=capabilities.zoom.step||0.1;
        zoomSlider.value=(capabilities.zoom.min+capabilities.zoom.max)/2;
        track.applyConstraints({advanced:[{zoom:zoomSlider.value}]});
    } else { zoomSlider.style.display='none'; }

    // Torch
    if(!capabilities.torch) torchBtn.style.display='none';

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    const processFrame = ()=>{
        if(video.readyState===video.HAVE_ENOUGH_DATA){
            canvas.width=video.videoWidth;
            canvas.height=video.videoHeight;
            ctx.drawImage(video,0,0);
            enhanceImage(canvas);

            const rotations=[0,90,180,270];
            let scanned=false;
            resultsDiv.innerHTML=''; // Clear previous
            for(const angle of rotations){
                const rotCanvas=document.createElement('canvas');
                const rotCtx=rotCanvas.getContext('2d');
                if(angle===90||angle===270){ rotCanvas.width=canvas.height; rotCanvas.height=canvas.width; } 
                else { rotCanvas.width=canvas.width; rotCanvas.height=canvas.height; }
                rotCtx.translate(rotCanvas.width/2,rotCanvas.height/2);
                rotCtx.rotate(angle*Math.PI/180);
                rotCtx.drawImage(canvas,-canvas.width/2,-canvas.height/2);
                try{
                    const luminanceSource = new RGBLuminanceSource(rotCtx.getImageData(0,0,rotCanvas.width,rotCanvas.height).data, rotCanvas.width, rotCanvas.height);
                    const bitmap = new BinaryBitmap(new HybridBinarizer(luminanceSource));
                    let results=[];
                    try{ results = reader.decodeMultiple(bitmap); } catch(e){ try{ results=[reader.decode(bitmap)]; } catch(e){ results=[]; } }
                    results.forEach(r=>createQRCanvas(r.getText(), resultsDiv));
                    if(results.length>0) scanned=true;
                } catch(e){ continue; }
                if(scanned) break;
            }
        }
        requestAnimationFrame(processFrame);
    }
    processFrame();
}).catch(err=>{ resultsDiv.innerText="Camera access denied or unavailable"; console.error(err); });

// Stop scanner
stopBtn.addEventListener('click',()=>{ if(stream){ stream.getTracks().forEach(t=>t.stop()); resultsDiv.innerHTML='Live scanner stopped'; } });

// Torch toggle
torchBtn.addEventListener('click',()=>{ if(stream){ const track=stream.getVideoTracks()[0]; torchOn=!torchOn; track.applyConstraints({advanced:[{torch:torchOn}]}); } });

// Zoom
zoomSlider.addEventListener('input',()=>{
    if(stream){
        const track=stream.getVideoTracks()[0];
        const capabilities=track.getCapabilities();
        if(capabilities.zoom){
            const value=parseFloat(zoomSlider.value);
            const zoomValue=Math.min(capabilities.zoom.max, Math.max(capabilities.zoom.min, value));
            track.applyConstraints({advanced:[{zoom:zoomValue}]}).catch(err=>console.error(err));
        }
    }
});

// --- PHOTO SCAN ---
photoInput.addEventListener('change', e=>{
    const file = e.target.files[0];
    if(!file) return;
    const img = new Image();
    img.onload = ()=>{
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img,0,0);
        enhanceImage(canvas);

        const rotations=[0,90,180,270];
        photoResultsDiv.innerHTML='';
        for(const angle of rotations){
            const rotCanvas=document.createElement('canvas');
            const rotCtx=rotCanvas.getContext('2d');
            if(angle===90||angle===270){ rotCanvas.width=canvas.height; rotCanvas.height=canvas.width; } 
            else { rotCanvas.width=canvas.width; rotCanvas.height=canvas.height; }
            rotCtx.translate(rotCanvas.width/2,rotCanvas.height/2);
            rotCtx.rotate(angle*Math.PI/180);
            rotCtx.drawImage(canvas,-canvas.width/2,-canvas.height/2);
            try{
                const luminanceSource = new RGBLuminanceSource(rotCtx.getImageData(0,0,rotCanvas.width,rotCanvas.height).data, rotCanvas.width, rotCanvas.height);
                const bitmap = new BinaryBitmap(new HybridBinarizer(luminanceSource));
                let results=[];
                try{ results=reader.decodeMultiple(bitmap); } catch(e){ try{ results=[reader.decode(bitmap)]; } catch(e){ results=[]; } }
                results.forEach(r=>createQRCanvas(r.getText(), photoResultsDiv));
            } catch(e){ continue; }
        }
        if(photoResultsDiv.children.length===0) photoResultsDiv.innerText='No barcodes detected';
    }
    img.src = URL.createObjectURL(file);
});
</script>

</body>
</html>
