<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Debug Camera + Data Matrix Scanner</title>
<script src="https://unpkg.com/html5-qrcode@2.3.9/minified/html5-qrcode.min.js"></script>
<style>
body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
#reader { width: 100%; max-width: 400px; margin: 20px auto; }
#cameraSelect { margin: 10px; padding: 8px; }
#result { margin-top: 20px; font-weight: bold; color: green; word-wrap: break-word; }
</style>
</head>
<body>

<h2>Debug Camera + Data Matrix Scanner</h2>

<select id="cameraSelect"><option>Requesting camera...</option></select>
<button id="startBtn">Start Scanner</button>
<div id="reader"></div>
<div id="result">Waiting for scan...</div>

<script>
const resultDiv = document.getElementById("result");
const selectEl = document.getElementById("cameraSelect");
const startBtn = document.getElementById("startBtn");

const html5QrCode = new Html5Qrcode("reader");

// Step 1: Force userMedia to unlock camera access
navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => {
  stream.getTracks().forEach(track => track.stop()); // close preview
  // Now enumerate devices
  return Html5Qrcode.getCameras();
})
.then(devices => {
  selectEl.innerHTML = "";
  if (devices && devices.length) {
    devices.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.text = d.label || `Camera ${selectEl.length+1}`;
      selectEl.appendChild(opt);
    });
  } else {
    selectEl.innerHTML = "<option>No cameras found</option>";
  }
})
.catch(err => {
  selectEl.innerHTML = "<option>Error: " + err + "</option>";
});

// Step 2: Start scanning when user clicks
startBtn.addEventListener("click", () => {
  const cameraId = selectEl.value;
  resultDiv.innerText = "Starting scanner...";

  html5QrCode.start(
    { deviceId: { exact: cameraId } },
    { fps: 10, qrbox: 250, formatsToSupport: [ Html5QrcodeSupportedFormats.DATA_MATRIX ] },
    decodedText => {
      resultDiv.innerText = "Decoded: " + decodedText;
    },
    errorMessage => {
      // Ignore decoding errors
    }
  ).catch(err => {
    resultDiv.innerText = "Error starting scanner: " + err;
  });
});
</script>

</body>
</html>
