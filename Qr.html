<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Take Picture â†’ Read Barcode â†’ Recreate</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bwip-js/4.7.0/bwip-js-min.js"></script>
<style>
  body { font-family: Arial; text-align: center; padding: 20px; }
  video, img, canvas { width: 100%; max-width: 400px; border-radius: 8px; margin-top: 10px; }
  button { margin-top: 10px; padding: 10px 16px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; background: #007bff; color: white; }
  button:hover { background: #0056b3; }
  #result { margin-top: 15px; font-weight: bold; color: green; }
</style>
</head>
<body>

<h2>Take Picture â†’ Read Barcode â†’ Recreate</h2>

<video id="video" autoplay playsinline></video>
<button id="captureBtn">ðŸ“¸ Take Picture</button>
<img id="photo" style="display:none;" />
<div id="result">No barcode detected yet.</div>
<canvas id="recreatedBarcode"></canvas>

<script>
const video = document.getElementById('video');
const photo = document.getElementById('photo');
const resultDiv = document.getElementById('result');
const recreatedCanvas = document.getElementById('recreatedBarcode');
let stream = null;

// Start rear camera
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }
    });
    video.srcObject = stream;
  } catch(err) {
    console.error(err);
    resultDiv.innerText = "Camera error: " + err.message;
  }
}
startCamera();

// Take picture
document.getElementById('captureBtn').addEventListener('click', async () => {
  if (!stream) { resultDiv.innerText = "No camera available"; return; }

  const track = stream.getVideoTracks()[0];
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const dataUrl = canvas.toDataURL('image/png');
  photo.src = dataUrl;
  photo.style.display = "block";

  // Convert to File for html5-qrcode
  const blob = await (await fetch(dataUrl)).blob();
  const file = new File([blob], "capture.png", { type: "image/png" });

  const html5QrCode = new Html5Qrcode("temp"); // temporary instance for file scan
  try {
    const result = await html5QrCode.scanFileV2(file, true);
    const decodedText = result.decodedText;
    resultDiv.innerText = "Detected: " + decodedText;

    // Recreate barcode using bwip-js
    try {
      // auto-select type: QR for QR codes, code128 for text
      const type = result.result.format === "QR_CODE" ? "qrcode" : "code128";
      BWIPJS.toCanvas(recreatedCanvas, {
        bcid: type,       // Barcode type
        text: decodedText, // Data to encode
        scale: 3,
        height: 10,
        includetext: true,
        textxalign: 'center'
      });
    } catch(err) {
      console.error(err);
      resultDiv.innerText += " | Failed to recreate barcode";
    }

  } catch(err) {
    console.error(err);
    resultDiv.innerText = "No barcode detected in the image";
  }
});
</script>

</body>
</html>
