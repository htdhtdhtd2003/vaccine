<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live QR Scanner with Zoom</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body { font-family: Arial; text-align: center; padding: 20px; }
#reader { width: 100%; max-width: 400px; margin: auto; border-radius:8px; }
#controls { margin-top: 10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
button { padding: 10px 14px; border:none; border-radius:6px; font-size:16px; cursor:pointer; background:#007bff; color:white; }
button:hover { background:#0056b3; }
input[type=range] { width:80%; max-width:300px; }
#result { margin-top: 15px; font-weight:bold; color: green; }
canvas { margin-top: 15px; width:200px; height:200px; }
</style>
</head>
<body>

<h2>Live QR Scanner with Zoom</h2>
<div id="reader"></div>

<div id="controls">
  <button id="torchBtn" style="display:none;">Toggle Torch</button>
  <input type="range" id="zoomSlider" min="1" max="1" step="0.1" value="1" style="display:none;">
</div>

<div id="result">Scanning...</div>
<canvas id="recreatedQR"></canvas>

<script>
let html5QrCode;
let videoTrack = null;
let torchOn = false;

// QR decode callback
function onScanSuccess(decodedText, decodedResult) {
  document.getElementById("result").innerText = "Scanned: " + decodedText;
  QRCode.toCanvas(document.getElementById("recreatedQR"), decodedText, { width: 200 }, err=>{
    if(err) console.error(err);
  });
}

function onScanError(errorMessage) {
  // optional logging
}

async function startLiveScanner() {
  try {
    const devices = await Html5Qrcode.getCameras();
    if (!devices || devices.length === 0) {
      document.getElementById("result").innerText = "No camera found";
      return;
    }

    const backCamera = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];

    html5QrCode = new Html5Qrcode("reader");
    await html5QrCode.start(
      { deviceId: { exact: backCamera.id } },
      { fps: 10, qrbox: 250 },
      onScanSuccess,
      onScanError
    );

    videoTrack = document.querySelector("video")?.srcObject?.getVideoTracks()[0];
    if (!videoTrack) return;
    const capabilities = videoTrack.getCapabilities();

    // Continuous autofocus
    if (capabilities.focusMode && capabilities.focusMode.includes("continuous")) {
      await videoTrack.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
    }

    // Torch support
    const torchBtn = document.getElementById("torchBtn");
    if (capabilities.torch) {
      torchBtn.style.display = "inline-block";
      torchBtn.addEventListener("click", () => {
        torchOn = !torchOn;
        videoTrack.applyConstraints({ advanced: [{ torch: torchOn }] }).catch(err => console.warn("Torch not supported", err));
      });
    }

    // Zoom support
    const zoomSlider = document.getElementById("zoomSlider");
    if (capabilities.zoom) {
      zoomSlider.min = capabilities.min;
      zoomSlider.max = capabilities.max;
      zoomSlider.step = capabilities.step || 0.1;
      zoomSlider.value = (capabilities.min + capabilities.max)/2;
      zoomSlider.style.display = "inline-block";

      // Apply initial zoom
      await videoTrack.applyConstraints({ advanced: [{ zoom: zoomSlider.value }] });

      zoomSlider.addEventListener("input", async (e) => {
        const val = e.target.value;
        try {
          await videoTrack.applyConstraints({ advanced: [{ zoom: val }] });
        } catch(err) {
          console.warn("Zoom adjustment failed", err);
        }
      });
    }

  } catch(err) {
    console.error(err);
    document.getElementById("result").innerText = "Camera access error: " + err;
  }
}

startLiveScanner();
</script>

</body>
</html>
